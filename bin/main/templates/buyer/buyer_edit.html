<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>구매자 정보 수정</title>
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ===== CSS 변수 ===== */
    :root {
      /* 색상 */
      --color-primary: #658352;
      --color-primary-hover: #94A687;
      --color-primary-light: rgba(101, 131, 82, 0.1);
      --color-white: #ffffff;
      --color-background: #FBF9EF;
      --color-text: #1E2203;
      --color-text-light: #666666;
      --color-border: #E9E7DE;
      --color-secondary-background: #F5F4ED;
      --color-success: #27ae60;
      --color-info: #3498db;
      --color-warning: #f39c12;
      --color-error: #e74c3c;
      
      /* 레이아웃 */
      --layout-max-width: 1400px;
      --container-max-width: 600px;
      --border-radius: 12px;
      --border-radius-large: 20px;
      --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.15);
      --shadow-heavy: 0 8px 25px rgba(0, 0, 0, 0.2);
      
      /* 타이포그래피 */
      --font-family-primary: 'Inter', sans-serif;
      --font-family-heading: 'Cabin', sans-serif;
      --font-size-small: 0.875rem;
      --font-size-base: 1rem;
      --font-size-large: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 2rem;
      --font-size-4xl: 2.5rem;
      
      /* 간격 */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 40px;
      --spacing-3xl: 48px;
      
      /* 애니메이션 */
      --transition-fast: 0.2s;
      --transition-normal: 0.3s;
      --transition-slow: 0.5s;
    }

    /* ===== 기본 스타일 ===== */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-primary);
      background-color: var(--color-background);
      color: var(--color-text);
      margin: 0;
      padding: 120px 20px 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      line-height: 1.6;
      font-size: var(--font-size-base);
    }

    /* ===== 네비게이션 바 ===== */
    .navbar-container {
      top: 0;
      left: 0;
      width: 100%;
      display: flex;
      z-index: 1000;
      position: fixed;
      justify-content: center;
      background: var(--color-white);
      box-shadow: var(--shadow-light);
    }
    
    .navbar {
      width: 100%;
      display: flex;
      max-width: var(--layout-max-width);
      align-items: center;
      padding: var(--spacing-md) var(--spacing-3xl);
      justify-content: space-between;
    }
    
    .navbar-logo-img {
      height: 3rem;
      border-radius: var(--border-radius);
      transition: transform var(--transition-fast);
    }
    
    .navbar-logo-img:hover {
      transform: scale(1.05);
    }
    
    .navbar-buttons {
      gap: var(--spacing-md);
      display: flex;
      align-items: center;
    }
    
    .btn-filled, .btn-outline {
      display: flex;
      align-items: center;
      font-weight: 600;
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: 24px;
      font-size: var(--font-size-base);
      text-decoration: none;
      cursor: pointer;
      border: 1px solid var(--color-primary);
      transition: all var(--transition-fast);
      font-family: var(--font-family-primary);
    }
    
    .btn-filled {
      color: var(--color-white);
      background: var(--color-primary);
    }
    
    .btn-filled:hover {
      background: var(--color-primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }
    
    .btn-outline {
      color: var(--color-primary);
      background: transparent;
    }
    
    .btn-outline:hover {
      background: var(--color-primary-light);
      transform: translateY(-1px);
    }
    
    .user-name {
      color: var(--color-primary);
      font-weight: 600;
      text-decoration: none;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 20px;
      transition: all var(--transition-fast);
    }
    
    .user-name:hover {
      background-color: var(--color-primary);
      color: var(--color-white);
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }

    /* ===== 편집 컨테이너 ===== */
    .edit-container {
      width: 100%;
      max-width: var(--container-max-width);
      text-align: center;
    }
    
    .edit-container h1 {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-4xl);
      color: var(--color-primary);
      margin-bottom: var(--spacing-xl);
      font-weight: 700;
    }

    /* ===== 편집 폼 ===== */
    .edit-form {
      background-color: var(--color-white);
      padding: var(--spacing-2xl) var(--spacing-2xl);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-medium);
      text-align: left;
      transition: box-shadow var(--transition-normal);
    }
    
    .edit-form:hover {
      box-shadow: var(--shadow-heavy);
    }

    /* ===== 폼 행 ===== */
    .form-row {
      margin-bottom: var(--spacing-lg);
    }
    
    .form-row label {
      display: block;
      margin-bottom: var(--spacing-sm);
      font-weight: 600;
      font-size: var(--font-size-base);
      color: var(--color-text);
      transition: color var(--transition-fast);
    }
    
    .form-row label:hover {
      color: var(--color-primary);
    }
    
    .form-row input, 
    .form-row select {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: var(--font-size-base);
      border: 2px solid var(--color-border);
      border-radius: var(--border-radius);
      box-sizing: border-box;
      transition: all var(--transition-fast);
      font-family: var(--font-family-primary);
      background-color: var(--color-white);
    }
    
    .form-row input:focus, 
    .form-row select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px rgba(101, 131, 82, 0.1);
      transform: translateY(-1px);
    }
    
    .form-row input:hover, 
    .form-row select:hover {
      border-color: var(--color-primary-hover);
    }
    
    .form-row input[readonly], 
    .form-row select[disabled] {
      background-color: var(--color-secondary-background);
      cursor: not-allowed;
      color: var(--color-text-light);
    }
    
    .form-row input[readonly]:hover, 
    .form-row select[disabled]:hover {
      border-color: var(--color-border);
      transform: none;
    }

    /* ===== 필수 표시 ===== */
    .required-mark {
      color: var(--color-primary);
      font-weight: bold;
      margin-right: var(--spacing-xs);
    }

    /* ===== 입력 컬럼 ===== */
    .input-col {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* ===== 우편번호 그룹 ===== */
    .postcode-group {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
    }
    
    #postcode {
      background-color: var(--color-secondary-background);
    }
    
    #searchPostcodeBtn {
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: var(--font-size-small);
      font-weight: 600;
      border-radius: var(--border-radius);
      border: 2px solid var(--color-primary);
      background-color: transparent;
      color: var(--color-primary);
      cursor: pointer;
      flex-shrink: 0;
      transition: all var(--transition-fast);
      font-family: var(--font-family-primary);
    }
    
    #searchPostcodeBtn:hover {
      background-color: var(--color-primary);
      color: var(--color-white);
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }
    
    #address, 
    #detailAddress {
      margin-bottom: var(--spacing-sm);
    }
    
    #address {
      background-color: var(--color-secondary-background);
    }

    /* ===== 폼 액션 ===== */
    .form-actions {
      margin-top: var(--spacing-xl);
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
    }
    
    .form-actions button {
      flex-grow: 1;
      padding: var(--spacing-sm) var(--spacing-lg);
      font-size: var(--font-size-large);
      font-weight: 700;
      border-radius: 24px;
      border: 2px solid;
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: var(--font-family-primary);
    }
    
    .save-btn {
      background-color: var(--color-primary);
      color: var(--color-white);
      border-color: var(--color-primary);
    }
    
    .save-btn:hover {
      background-color: var(--color-primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }
    
    .cancel-btn {
      background-color: var(--color-white);
      color: var(--color-text-light);
      border-color: var(--color-border);
    }
    
    .cancel-btn:hover {
      background-color: var(--color-secondary-background);
      color: var(--color-text);
      transform: translateY(-1px);
      box-shadow: var(--shadow-light);
    }

    /* ===== 에러 메시지 ===== */
    .error-message {
      color: var(--color-error);
      font-size: var(--font-size-small);
      margin-top: var(--spacing-xs);
      font-weight: 500;
      padding: var(--spacing-xs) var(--spacing-sm);
      background-color: rgba(231, 76, 60, 0.1);
      border-radius: var(--border-radius);
      border-left: 3px solid var(--color-error);
    }
    
    .global-error {
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-md);
      background-color: rgba(231, 76, 60, 0.1);
      border: 1px solid var(--color-error);
      border-radius: var(--border-radius);
      color: var(--color-error);
      text-align: center;
      font-weight: 500;
    }

    /* ===== 성공 메시지 ===== */
    .success-message {
      color: var(--color-success);
      font-size: var(--font-size-small);
      margin-top: var(--spacing-xs);
      font-weight: 500;
      padding: var(--spacing-xs) var(--spacing-sm);
      background-color: rgba(39, 174, 96, 0.1);
      border-radius: var(--border-radius);
      border-left: 3px solid var(--color-success);
    }

    /* ===== 로딩 상태 ===== */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid var(--color-primary);
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== 반응형 디자인 ===== */
    @media screen and (max-width: 768px) {
      .edit-container {
        max-width: 100%;
        padding: 0 var(--spacing-md);
      }
      
      .edit-form {
        padding: var(--spacing-lg);
      }
      
      .edit-container h1 {
        font-size: var(--font-size-3xl);
      }
      
      .form-actions {
        flex-direction: column;
        gap: var(--spacing-sm);
      }
      
      .form-actions button {
        width: 100%;
      }
      
      .postcode-group {
        flex-direction: column;
        gap: var(--spacing-sm);
      }
      
      #searchPostcodeBtn {
        width: 100%;
        padding: var(--spacing-sm);
      }
    }
    
    @media screen and (max-width: 480px) {
      .edit-form {
        padding: var(--spacing-md);
      }
      
      .edit-container h1 {
        font-size: var(--font-size-2xl);
      }
      
      .form-row input, 
      .form-row select {
        padding: var(--spacing-sm);
        font-size: var(--font-size-base);
      }
    }

    /* ===== 접근성 개선 ===== */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* 포커스 표시 개선 */
    button:focus,
    a:focus,
    input:focus,
    select:focus {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }
    
    /* 필수 필드 표시 */
    .form-row label[for*="required"]::after {
      content: " *";
      color: var(--color-error);
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- 네비게이션 바 -->
  <header class="navbar-container">
    <div class="navbar">
      <a th:href="@{/home}" aria-label="홈으로 이동">
        <img th:src="@{/images/free-icon-sprout-7101338.png}" alt="로고" class="navbar-logo-img"/>
      </a>
      <div class="navbar-buttons">
        <a th:href="@{/buyer/info}" class="btn-outline" aria-label="내 정보">내 정보</a>
        <form th:action="@{/buyer/logout}" method="post" style="display:inline;">
          <button type="submit" class="btn-filled">로그아웃</button>
        </form>
      </div>
    </div>
  </header>

  <!-- 메인 컨텐츠 -->
  <main class="edit-container">
    <h1>구매자 정보 수정</h1>
    
    <form th:action="@{/buyer/edit}" method="post" th:object="${buyerEditForm}" class="edit-form" novalidate>
      <!-- 전역 오류 메시지 표시 -->
      <div th:if="${#fields.hasGlobalErrors()}" class="global-error" role="alert" aria-live="polite">
        <div th:each="error : ${#fields.globalErrors()}" th:text="${error}"></div>
      </div>

      <!-- 이메일 필드 -->
      <div class="form-row">
        <label for="email">이메일 (수정 불가)</label>
        <input type="email" 
               id="email" 
               th:field="*{email}" 
               readonly 
               aria-describedby="email-description">
        <div id="email-description" class="sr-only">이메일은 수정할 수 없습니다.</div>
      </div>

      <!-- 이름 필드 -->
      <div class="form-row">
        <label for="name">이름 (수정 불가)</label>
        <input type="text" 
               id="name" 
               th:field="*{name}" 
               readonly 
               aria-describedby="name-description">
        <div id="name-description" class="sr-only">이름은 수정할 수 없습니다.</div>
      </div>

      <!-- 닉네임 필드 -->
      <div class="form-row">
        <label for="nickname">닉네임</label>
        <input type="text" 
               id="nickname" 
               th:field="*{nickname}" 
               required 
               aria-describedby="nickname-error"
               placeholder="닉네임을 입력하세요">
        <div th:if="${#fields.hasErrors('nickname')}" 
             th:errors="*{nickname}" 
             id="nickname-error"
             class="error-message" 
             role="alert" 
             aria-live="polite"></div>
      </div>

      <!-- 연락처 필드 -->
      <div class="form-row">
        <label for="tel">연락처</label>
        <input type="tel" 
               id="tel" 
               th:field="*{tel}" 
               maxlength="13" 
               placeholder="010-0000-0000" 
               required 
               aria-describedby="tel-error tel-help"
               pattern="[0-9]{3}-[0-9]{4}-[0-9]{4}">
        <div id="tel-help" class="sr-only">연락처는 010-0000-0000 형식으로 입력해주세요.</div>
        <div th:if="${#fields.hasErrors('tel')}" 
             th:errors="*{tel}" 
             id="tel-error"
             class="error-message" 
             role="alert" 
             aria-live="polite"></div>
      </div>

      <!-- 성별 필드 -->
      <div class="form-row">
        <label for="gender">성별</label>
        <select id="gender" 
                th:field="*{gender}" 
                aria-describedby="gender-error">
          <option value="">선택해주세요</option>
          <option value="남성">남성</option>
          <option value="여성">여성</option>
        </select>
        <div th:if="${#fields.hasErrors('gender')}" 
             th:errors="*{gender}" 
             id="gender-error"
             class="error-message" 
             role="alert" 
             aria-live="polite"></div>
      </div>

      <!-- 생년월일 필드 -->
      <div class="form-row">
        <label for="birth">생년월일</label>
        <input type="date" 
               id="birth" 
               name="birth"
               th:field="*{birth}"
               aria-describedby="birth-error">
        <div th:if="${#fields.hasErrors('birth')}" 
             th:errors="*{birth}" 
             id="birth-error"
             class="error-message" 
             role="alert" 
             aria-live="polite"></div>
      </div>

      <!-- 주소 필드 -->
      <div class="form-row">
        <label for="postNumber">주소</label>
        <div class="input-col">
          <div class="postcode-group">
            <input type="text" 
                   id="postNumber" 
                   name="postNumber" 
                   th:field="*{postNumber}" 
                   placeholder="우편번호" 
                   readonly 
                   aria-describedby="postcode-help">
            <button type="button" 
                    id="searchPostcodeBtn" 
                    onclick="addressManager.openAddressPopup()" 
                    aria-label="주소 검색">
              주소 검색
            </button>
          </div>
          <div id="postcode-help" class="sr-only">주소 검색 버튼을 클릭하여 우편번호를 찾으세요.</div>
          <div th:if="${#fields.hasErrors('postNumber')}" 
               th:errors="*{postNumber}" 
               class="error-message" 
               role="alert" 
               aria-live="polite"></div>

          <input type="text" 
                 id="address" 
                 placeholder="주소" 
                 readonly 
                 aria-describedby="address-help">
          <div id="address-help" class="sr-only">주소 검색을 통해 자동으로 입력됩니다.</div>
          
          <input type="text" 
                 id="detailAddress" 
                 placeholder="상세주소" 
                 aria-describedby="detail-address-help">
          <div id="detail-address-help" class="sr-only">상세주소를 입력해주세요.</div>

          <div th:if="${#fields.hasErrors('address')}" 
               th:errors="*{address}" 
               class="error-message" 
               role="alert" 
               aria-live="polite"></div>

          <!-- 서버로 보낼 최종 주소값 (숨겨진 필드) -->
          <input type="hidden" 
                 id="fullAddress" 
                 name="address" 
                 th:field="*{address}">
        </div>
      </div>

      <!-- 폼 액션 버튼 -->
      <div class="form-actions" role="group" aria-label="폼 액션">
        <button type="button" 
                class="cancel-btn" 
                onclick="location.href='/buyer/info'"
                aria-label="취소하고 내 정보 페이지로 이동">
          취소
        </button>
        <button type="submit" 
                class="save-btn" 
                aria-label="정보 저장">
          저장
        </button>
      </div>
    </form>
  </main>

  <!-- 주소 검색을 위한 스크립트 -->
  <script>
    // ===== 구매자 정보 편집 관리자 클래스 =====
    class BuyerEditManager {
      constructor() {
        this.elements = this.initializeElements();
        this.addressManager = new AddressManager();
        this.formValidator = new FormValidator();
        
        this.initialize();
      }

      // ===== 요소 초기화 =====
      initializeElements() {
        return {
          form: document.querySelector('.edit-form'),
          telInput: document.getElementById('tel'),
          nicknameInput: document.getElementById('nickname'),
          genderSelect: document.getElementById('gender'),
          birthInput: document.getElementById('birth'),
          detailAddressInput: document.getElementById('detailAddress'),
          addressInput: document.getElementById('address'),
          postNumberInput: document.getElementById('postNumber'),
          fullAddressInput: document.getElementById('fullAddress'),
          saveBtn: document.querySelector('.save-btn'),
          cancelBtn: document.querySelector('.cancel-btn')
        };
      }

      // ===== 초기화 =====
      initialize() {
        console.log('=== 구매자 정보 편집 페이지 초기화 ===');
        
        this.bindEvents();
        this.setupFormValidation();
        this.setupAccessibility();
        
        console.log('구매자 정보 편집 페이지 초기화 완료');
      }

      // ===== 이벤트 바인딩 =====
      bindEvents() {
        // 폼 제출 이벤트
        this.elements.form.addEventListener('submit', (e) => {
          this.handleFormSubmit(e);
        });

        // 전화번호 자동 하이픈
        this.elements.telInput.addEventListener('input', (e) => {
          this.formatPhoneNumber(e.target);
        });

        // 키보드 네비게이션
        this.setupKeyboardNavigation();

        // 실시간 유효성 검사
        this.setupRealTimeValidation();
      }

      // ===== 폼 제출 처리 =====
      async handleFormSubmit(e) {
        e.preventDefault();
        
        if (!this.formValidator.validateForm()) {
          return;
        }

        try {
          this.setLoadingState(true);
          
          // 폼 데이터 수집
          const formData = this.collectFormData();
          
          // 서버로 제출
          const response = await this.submitForm(formData);
          
          if (response.success) {
            this.showSuccessMessage('정보가 성공적으로 수정되었습니다.');
            setTimeout(() => {
              window.location.href = '/buyer/info';
            }, 1500);
          } else {
            this.showErrorMessage(response.message || '정보 수정에 실패했습니다.');
          }
        } catch (error) {
          console.error('폼 제출 중 오류:', error);
          this.showErrorMessage('서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
        } finally {
          this.setLoadingState(false);
        }
      }

      // ===== 폼 데이터 수집 =====
      collectFormData() {
        const formData = new FormData(this.elements.form);
        
        // 주소 정보 결합
        const baseAddr = this.elements.addressInput.value.trim();
        const detail = this.elements.detailAddressInput.value.trim();
        const fullAddress = baseAddr + ' ' + detail;
        
        formData.set('address', fullAddress);
        
        return formData;
      }

      // ===== 폼 제출 =====
      async submitForm(formData) {
        const response = await fetch('/buyer/edit', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();
      }

      // ===== 전화번호 포맷팅 =====
      formatPhoneNumber(input) {
        let value = input.value.replace(/[^\d]/g, '');
        
        if (value.length <= 3) {
          input.value = value;
        } else if (value.length <= 7) {
          input.value = value.slice(0, 3) + '-' + value.slice(3);
        } else {
          input.value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
        }
      }

      // ===== 키보드 네비게이션 =====
      setupKeyboardNavigation() {
        const inputs = this.elements.form.querySelectorAll('input, select');
        
        inputs.forEach((input, index) => {
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              
              // 다음 입력 필드로 이동
              const nextInput = inputs[index + 1];
              if (nextInput) {
                nextInput.focus();
              } else {
                // 마지막 필드에서 Enter 시 저장 버튼 클릭
                this.elements.saveBtn.click();
              }
            }
          });
        });
      }

      // ===== 실시간 유효성 검사 =====
      setupRealTimeValidation() {
        // 닉네임 검사
        this.elements.nicknameInput.addEventListener('blur', () => {
          this.formValidator.validateNickname(this.elements.nicknameInput.value);
        });

        // 전화번호 검사
        this.elements.telInput.addEventListener('blur', () => {
          this.formValidator.validatePhone(this.elements.telInput.value);
        });

        // 생년월일 검사
        this.elements.birthInput.addEventListener('blur', () => {
          this.formValidator.validateBirth(this.elements.birthInput.value);
        });
      }

      // ===== 폼 유효성 검사 설정 =====
      setupFormValidation() {
        this.formValidator.setForm(this.elements.form);
      }

      // ===== 접근성 설정 =====
      setupAccessibility() {
        // 필수 필드 표시
        const requiredFields = this.elements.form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
          const label = this.elements.form.querySelector(`label[for="${field.id}"]`);
          if (label) {
            label.classList.add('required');
          }
        });

        // 에러 메시지 접근성
        const errorMessages = this.elements.form.querySelectorAll('.error-message');
        errorMessages.forEach(message => {
          message.setAttribute('role', 'alert');
          message.setAttribute('aria-live', 'polite');
        });
      }

      // ===== 로딩 상태 설정 =====
      setLoadingState(isLoading) {
        const submitBtn = this.elements.saveBtn;
        
        if (isLoading) {
          submitBtn.disabled = true;
          submitBtn.textContent = '저장 중...';
          submitBtn.classList.add('loading');
        } else {
          submitBtn.disabled = false;
          submitBtn.textContent = '저장';
          submitBtn.classList.remove('loading');
        }
      }

      // ===== 성공 메시지 표시 =====
      showSuccessMessage(message) {
        this.showMessage(message, 'success');
      }

      // ===== 에러 메시지 표시 =====
      showErrorMessage(message) {
        this.showMessage(message, 'error');
      }

      // ===== 메시지 표시 =====
      showMessage(message, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `${type}-message`;
        messageDiv.textContent = message;
        messageDiv.setAttribute('role', 'alert');
        messageDiv.setAttribute('aria-live', 'polite');
        
        const form = this.elements.form;
        form.insertBefore(messageDiv, form.firstChild);
        
        // 5초 후 자동 제거
        setTimeout(() => {
          messageDiv.remove();
        }, 5000);
      }

      // ===== 페이지 통계 수집 =====
      trackPageView() {
        console.log('구매자 정보 편집 페이지 조회');
        // Google Analytics나 다른 분석 도구 연동 가능
      }
    }

    // ===== 주소 관리자 클래스 =====
    class AddressManager {
      constructor() {
        this.elements = {
          postNumber: document.getElementById('postNumber'),
          address: document.getElementById('address'),
          detailAddress: document.getElementById('detailAddress'),
          fullAddress: document.getElementById('fullAddress'),
          searchBtn: document.getElementById('searchPostcodeBtn')
        };
        
        this.bindEvents();
      }

      // ===== 이벤트 바인딩 =====
      bindEvents() {
        // 주소 입력 변경 시 fullAddress 업데이트
        this.elements.detailAddress.addEventListener('input', () => {
          this.updateFullAddress();
        });
        
        this.elements.address.addEventListener('input', () => {
          this.updateFullAddress();
        });
      }

      // ===== 주소 팝업 열기 =====
      openAddressPopup() {
        new daum.Postcode({
          oncomplete: (data) => {
            this.handleAddressComplete(data);
          },
          onclose: () => {
            console.log('주소 검색 팝업이 닫혔습니다.');
          }
        }).open();
      }

      // ===== 주소 검색 완료 처리 =====
      handleAddressComplete(data) {
        const postNumber = data.zonecode;
        const roadAddr = data.roadAddress;
        const jibunAddr = data.jibunAddress;
        const baseAddr = roadAddr || jibunAddr;

        this.elements.postNumber.value = postNumber;
        this.elements.address.value = baseAddr;

        // 상세주소 필드로 포커스 이동
        this.elements.detailAddress.focus();
        
        // fullAddress 업데이트
        this.updateFullAddress();
        
        console.log('주소 검색 완료:', { postNumber, baseAddr });
      }

      // ===== 전체 주소 업데이트 =====
      updateFullAddress() {
        const baseAddr = this.elements.address.value.trim();
        const detail = this.elements.detailAddress.value.trim();
        const fullAddress = baseAddr + ' ' + detail;
        
        this.elements.fullAddress.value = fullAddress;
      }

      // ===== 주소 유효성 검사 =====
      validateAddress() {
        const postNumber = this.elements.postNumber.value.trim();
        const address = this.elements.address.value.trim();
        const detailAddress = this.elements.detailAddress.value.trim();
        
        if (!postNumber) {
          return { isValid: false, message: '우편번호를 검색해주세요.' };
        }
        
        if (!address) {
          return { isValid: false, message: '주소를 검색해주세요.' };
        }
        
        if (!detailAddress) {
          return { isValid: false, message: '상세주소를 입력해주세요.' };
        }
        
        return { isValid: true };
      }
    }

    // ===== 폼 유효성 검사 클래스 =====
    class FormValidator {
      constructor() {
        this.form = null;
        this.validationRules = {
          nickname: {
            required: true,
            minLength: 2,
            maxLength: 20,
            pattern: /^[가-힣a-zA-Z0-9]+$/
          },
          phone: {
            required: true,
            pattern: /^010-\d{4}-\d{4}$/
          },
          birth: {
            required: false,
            pattern: /^\d{4}-\d{2}-\d{2}$/
          }
        };
      }

      // ===== 폼 설정 =====
      setForm(form) {
        this.form = form;
      }

      // ===== 전체 폼 검증 =====
      validateForm() {
        const nickname = document.getElementById('nickname').value;
        const phone = document.getElementById('tel').value;
        const birth = document.getElementById('birth').value;
        
        const nicknameResult = this.validateNickname(nickname);
        const phoneResult = this.validatePhone(phone);
        const birthResult = this.validateBirth(birth);
        
        return nicknameResult && phoneResult && birthResult;
      }

      // ===== 닉네임 검증 =====
      validateNickname(value) {
        const rules = this.validationRules.nickname;
        
        if (rules.required && !value.trim()) {
          this.showFieldError('nickname', '닉네임을 입력해주세요.');
          return false;
        }
        
        if (value.length < rules.minLength) {
          this.showFieldError('nickname', `닉네임은 최소 ${rules.minLength}자 이상이어야 합니다.`);
          return false;
        }
        
        if (value.length > rules.maxLength) {
          this.showFieldError('nickname', `닉네임은 최대 ${rules.maxLength}자까지 가능합니다.`);
          return false;
        }
        
        if (!rules.pattern.test(value)) {
          this.showFieldError('nickname', '닉네임은 한글, 영문, 숫자만 사용 가능합니다.');
          return false;
        }
        
        this.clearFieldError('nickname');
        return true;
      }

      // ===== 전화번호 검증 =====
      validatePhone(value) {
        const rules = this.validationRules.phone;
        
        if (rules.required && !value.trim()) {
          this.showFieldError('tel', '연락처를 입력해주세요.');
          return false;
        }
        
        if (!rules.pattern.test(value)) {
          this.showFieldError('tel', '연락처는 010-0000-0000 형식으로 입력해주세요.');
          return false;
        }
        
        this.clearFieldError('tel');
        return true;
      }

      // ===== 생년월일 검증 =====
      validateBirth(value) {
        if (!value) return true; // 선택사항
        
        const rules = this.validationRules.birth;
        
        if (!rules.pattern.test(value)) {
          this.showFieldError('birth', '올바른 날짜 형식으로 입력해주세요.');
          return false;
        }
        
        const birthDate = new Date(value);
        const today = new Date();
        
        if (birthDate > today) {
          this.showFieldError('birth', '생년월일은 오늘 날짜보다 이전이어야 합니다.');
          return false;
        }
        
        this.clearFieldError('birth');
        return true;
      }

      // ===== 필드 에러 표시 =====
      showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const errorDiv = document.getElementById(`${fieldId}-error`);
        
        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.style.display = 'block';
        }
        
        field.classList.add('error');
      }

      // ===== 필드 에러 제거 =====
      clearFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        const errorDiv = document.getElementById(`${fieldId}-error`);
        
        if (errorDiv) {
          errorDiv.textContent = '';
          errorDiv.style.display = 'none';
        }
        
        field.classList.remove('error');
      }
    }

    // ===== 전역 함수들 =====
    function goToMyPage() {
      window.location.href = '/buyer/info';
    }

    function goToHome() {
      window.location.href = '/home';
    }

    // ===== 초기화 =====
    document.addEventListener('DOMContentLoaded', () => {
      const buyerEditManager = new BuyerEditManager();
      
      // 페이지 통계 수집
      setTimeout(() => {
        buyerEditManager.trackPageView();
      }, 1000);
    });
  </script>
</body>
</html>