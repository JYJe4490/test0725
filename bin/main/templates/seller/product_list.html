<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>상품 목록</title>
  <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ===== CSS 변수 정의 ===== */
    :root {
      --color-primary: #658352;
      --color-primary-hover: #94A687;
      --color-white: #ffffff;
      --color-background: #FBF9EF;
      --color-text: #1E2203;
      --color-border: #E9E7DE;
      --color-secondary-background: #F5F4ED;
      --color-danger: #e74c3c;
      --color-danger-dark: #c0392b;
      --color-success: #2a7c3e;
      --color-warning: #b82a0b;
      --color-muted: #666;
      --layout-max-width: 1400px;
      --layout-radius-card: 20px;
      --layout-radius-button: 12px;
      --layout-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
      --transition-default: all 0.2s ease;
    }

    /* ===== 기본 스타일 ===== */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', 'Cabin', sans-serif;
      background-color: var(--color-background);
      color: var(--color-text);
      padding-top: 80px;
      line-height: 1.6;
    }

    /* ===== 네비게이션 바 ===== */
    .navbar-container {
      top: 0;
      left: 0;
      width: 100%;
      display: flex;
      z-index: 1000;
      position: fixed;
      justify-content: center;
      background: var(--color-white);
      box-shadow: 0 2px 12px 0 rgba(0,0,0,0.06);
    }

    .navbar {
      width: 100%;
      display: flex;
      max-width: var(--layout-max-width);
      align-items: center;
      padding: 16px 48px;
      justify-content: space-between;
    }

    .navbar-logo-img {
      height: 3rem;
      border-radius: 8px;
      transition: var(--transition-default);
    }

    .navbar-logo-img:hover {
      transform: scale(1.05);
    }

    .navbar-buttons {
      gap: 16px;
      display: flex;
      align-items: center;
    }

    .btn-filled, .btn-outline {
      display: flex;
      align-items: center;
      font-weight: bold;
      padding: 10px 24px;
      border-radius: 24px;
      font-size: 1rem;
      text-decoration: none;
      transition: var(--transition-default);
      cursor: pointer;
      border: 1px solid var(--color-primary);
      white-space: nowrap;
    }

    .btn-filled {
      color: var(--color-white);
      background: var(--color-primary);
    }

    .btn-filled:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-outline {
      color: var(--color-primary);
      background: transparent;
    }

    .btn-outline:hover {
      background: rgba(101, 131, 82, 0.1);
      transform: translateY(-1px);
    }

    /* ===== 페이지 컨테이너 ===== */
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      box-sizing: border-box;
    }

    /* ===== 페이지 제목 ===== */
    h2 {
      font-family: 'Cabin', sans-serif;
      font-weight: 700;
      color: var(--color-primary);
      text-align: center;
      font-size: 2.4rem;
      margin: 0 0 32px 0;
    }

    /* ===== 리스트 컨테이너 ===== */
    .list-container {
      background-color: var(--color-white);
      padding: 32px 40px;
      border-radius: var(--layout-radius-card);
      box-shadow: var(--layout-shadow);
      width: 100%;
      max-width: 990px;
      margin: 0 auto;
    }

    /* ===== 리스트 헤더 ===== */
    .list-header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding-bottom: 24px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--color-border);
    }

    .header-buttons {
      display: flex;
      gap: 12px;
    }

    /* ===== 액션 버튼 ===== */
    .action-btn {
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: bold;
      border-radius: var(--layout-radius-button);
      color: white;
      cursor: pointer;
      transition: var(--transition-default);
      text-decoration: none;
      display: inline-block;
      border: none;
      font-family: inherit;
    }

    .delete-btn {
      background-color: var(--color-danger);
    }

    .delete-btn:hover {
      background-color: var(--color-danger-dark);
      transform: translateY(-1px);
    }

    .add-btn {
      background: var(--color-primary);
    }

    .add-btn:hover {
      background: var(--color-primary-hover);
      transform: translateY(-1px);
    }

    /* ===== 일괄 상태 변경 드롭다운 ===== */
    .bulk-status-select {
      padding: 12px 16px;
      font-size: 1rem;
      font-weight: bold;
      border-radius: var(--layout-radius-button);
      border: 1px solid var(--color-primary);
      background-color: white;
      color: var(--color-primary);
      cursor: pointer;
      transition: var(--transition-default);
      font-family: inherit;
      min-width: 140px;
    }

    .bulk-status-select:disabled {
      background-color: var(--color-disabled);
      color: var(--color-muted);
      cursor: not-allowed;
      border-color: var(--color-border);
    }

    .bulk-status-select:not(:disabled):hover {
      background-color: rgba(101, 131, 82, 0.1);
      transform: translateY(-1px);
    }

    .bulk-status-select:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(101, 131, 82, 0.2);
    }

    /* ===== 수정 버튼 ===== */
    .edit-btn {
      padding: 8px 16px;
      font-size: 0.9rem;
      border-radius: 8px;
      border: 1px solid var(--color-primary);
      background-color: transparent;
      color: var(--color-primary);
      cursor: pointer;
      font-weight: bold;
      transition: var(--transition-default);
      text-decoration: none;
      min-width: 60px;
      font-family: inherit;
    }

    .edit-btn:hover {
      background-color: var(--color-primary);
      color: white;
      transform: translateY(-1px);
    }

    /* ===== 테이블 스타일 ===== */
    .product-table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
      font-size: 0.95rem;
    }

    .product-table th, .product-table td {
      padding: 16px 8px;
      border-bottom: 1px solid var(--color-border);
    }

    .product-table th {
      background-color: var(--color-secondary-background);
      font-weight: bold;
      color: var(--color-text);
      font-size: 1rem;
    }

    .product-table tbody tr:hover {
      background-color: rgba(101, 131, 82, 0.05);
    }

    .product-table .title a {
      color: inherit;
      text-decoration: none;
      font-weight: 600;
    }

    .product-table .title a:hover {
      color: var(--color-primary);
      text-decoration: underline;
    }

    /* ===== 컬럼 너비 조정 ===== */
    .checkbox-column {
      width: 40px !important;
    }

    .number-column {
      width: 60px !important;
    }

    .title-column {
      width: 35% !important;
      text-align: left !important;
      padding-left: 16px !important;
    }

    .price-column {
      width: 120px !important;
    }

    .stock-column {
      width: 80px !important;
    }

    .status-column {
      width: 100px !important;
    }

    .date-column {
      width: 100px !important;
    }

    .action-column {
      width: 80px !important;
    }

    /* ===== 체크박스 스타일 ===== */
    .product-table input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    /* ===== 상태 태그 스타일 ===== */
    .status-tag {
      padding: 6px 12px;
      border-radius: 16px;
      font-weight: bold;
      font-size: 0.85rem;
      display: inline-block;
      min-width: 70px;
    }

    .status-tag.판매중 {
      background-color: #e0f0e3;
      color: var(--color-success);
    }

    .status-tag.재고소진 {
      background-color: #fbeae5;
      color: var(--color-warning);
    }

    .status-tag.비활성화 {
      background-color: #f0f0f0;
      color: var(--color-muted);
    }

    /* ===== 상태 변경 드롭다운 스타일 ===== */
    .status-select {
      padding: 6px 12px;
      border-radius: 16px;
      font-weight: bold;
      font-size: 0.85rem;
      border: 1px solid var(--color-border);
      background-color: white;
      cursor: pointer;
      min-width: 80px;
      text-align: center;
      font-family: inherit;
      transition: var(--transition-default);
    }

    .status-select.판매중 {
      background-color: #e0f0e3;
      color: var(--color-success);
      border-color: var(--color-success);
    }

    .status-select.재고소진 {
      background-color: #fbeae5;
      color: var(--color-warning);
      border-color: var(--color-warning);
    }

    .status-select.비활성화 {
      background-color: #f0f0f0;
      color: var(--color-muted);
      border-color: var(--color-muted);
    }

    .status-select:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(101, 131, 82, 0.2);
    }

    /* ===== 빈 데이터 메시지 ===== */
    .empty-message {
      padding: 40px;
      text-align: center;
      color: var(--color-muted);
      font-size: 1.1rem;
    }

    /* ===== 로딩 상태 ===== */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid var(--color-primary);
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== 반응형 디자인 ===== */
    @media screen and (max-width: 768px) {
      .container {
        padding: 0 16px;
      }

      .list-container {
        padding: 24px 20px;
      }

      .product-table {
        font-size: 0.9rem;
      }

      .product-table th, .product-table td {
        padding: 12px 4px;
      }

      .action-btn {
        padding: 10px 16px;
        font-size: 0.9rem;
        min-width: 80px;
      }

      .header-buttons {
        flex-direction: column;
        gap: 8px;
      }

      .product-table {
        display: block;
        overflow-x: auto;
      }

      .bulk-status-select {
        min-width: 120px;
        font-size: 0.9rem;
        padding: 10px 12px;
      }
    }
  </style>
</head>
<body>
  <!-- 네비게이션 바 -->
  <header class="navbar-container">
    <div class="navbar">
      <a th:href="@{/home}">
        <img th:src="@{/images/free-icon-sprout-7101338.png}" alt="로고" class="navbar-logo-img"/>
      </a>
      <div class="navbar-buttons">
        <a th:if="${name != null}" th:href="@{/seller/myPage/{sid}(sid=${sid})}" style="margin-right: 12px; font-weight: bold; text-decoration: none; color: var(--color-primary);">
          <span th:text="${name}">님</span>
        </a>
        <a th:href="@{/seller/main/{sid}(sid=${sid})}" class="btn-outline">대시보드</a>
        <form th:action="@{/seller/logout}" method="post" style="display:inline;">
          <button type="submit" class="btn-filled">로그아웃</button>
        </form>
      </div>
    </div>
  </header>

  <div class="container">
    <h2>상품 목록</h2>

    <div class="list-container">
      <form id="productActionForm" th:action="@{/seller/products/delete}" method="post">
        <input type="hidden" name="sid" th:value="${sid}" />
        
        <div class="list-header">
          <div class="header-buttons">
            <a th:href="@{/seller/add/{sid}(sid=${sid})}" class="action-btn add-btn">상품 등록</a>
            <select id="bulkStatusSelect" class="bulk-status-select" disabled>
              <option value="">상태 변경</option>
              <option value="판매중">판매중</option>
              <option value="재고소진">재고소진</option>
              <option value="비활성화">비활성화</option>
            </select>
          </div>
        </div>

        <table class="product-table">
          <thead>
            <tr>
              <th class="checkbox-column">
                <input type="checkbox" id="selectAll" />
              </th>
              <th class="number-column">번호</th>
              <th class="title-column">게시글 제목</th>
              <th class="price-column">가격</th>
              <th class="stock-column">재고</th>
              <th class="status-column">판매 상태</th>
              <th class="date-column">등록일</th>
              <th class="action-column">관리</th>
            </tr>
          </thead>
          <tbody>
            <tr th:if="${products.isEmpty()}">
              <td colspan="8" class="empty-message">등록된 상품이 없습니다.</td>
            </tr>
            <tr th:each="product, stat : ${products}">
              <td class="checkbox-column">
                <input type="checkbox" name="productIds" th:value="${product.productId}" />
              </td>
              <td class="number-column" th:text="${stat.count}">1</td>
              <td class="title title-column">
                <a th:href="@{/seller/product/{id}(id=${product.productId})}" th:text="${product.title}">게시글 제목</a>
              </td>
              <td class="price-column" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + '원'">18,000원</td>
              <td class="stock-column" th:text="${product.quantity} + '개'">50개</td>
              <td class="status-column">
                <select class="status-select" th:classappend="${product.status}" th:value="${product.status}" 
                        th:data-product-id="${product.productId}" onchange="updateProductStatus(this)">
                  <option value="판매중" th:selected="${product.status == '판매중'}">판매중</option>
                  <option value="비활성화" th:selected="${product.status == '비활성화'}">비활성화</option>
                  <option value="재고소진" th:selected="${product.status == '재고소진'}">재고소진</option>
                </select>
              </td>
              <td class="date-column" th:text="${#temporals.format(product.cdate, 'yyyy/MM/dd')}">2024/05/21</td>
              <td class="action-column">
                <a th:href="@{/seller/product/{id}/edit(id=${product.productId})}" class="edit-btn">수정</a>
              </td>
            </tr>
          </tbody>
        </table>
      </form>
    </div>
  </div>

  <script>
    // ===== 상수 정의 =====
    const API_ENDPOINTS = {
      PRODUCT_STATUS: '/seller/api/product/status'
    };

    const STATUS_TYPES = {
      SELLING: '판매중',
      DISABLED: '비활성화',
      OUT_OF_STOCK: '재고소진'
    };

    // ===== 클래스 정의 =====
    class ProductListManager {
      constructor() {
        this.selectAllCheckbox = document.getElementById('selectAll');
        this.productCheckboxes = document.querySelectorAll('input[name="productIds"]');
        this.bulkStatusSelect = document.getElementById('bulkStatusSelect');
        this.productActionForm = document.getElementById('productActionForm');
        
        this.init();
      }

      init() {
        this.bindEvents();
      }

      bindEvents() {
        // 전체 선택 체크박스
        this.selectAllCheckbox.addEventListener('change', (event) => {
          console.log('전체 선택 체크박스 변경됨:', event.target.checked);
          this.handleSelectAll();
        });
        
        // 개별 체크박스 변경 시 전체 선택 상태 업데이트
        this.productCheckboxes.forEach(checkbox => {
          checkbox.addEventListener('change', () => {
            console.log('개별 체크박스 변경됨');
            this.updateSelectAllState();
          });
        });

        // 일괄 상태 변경 드롭다운
        this.bulkStatusSelect.addEventListener('change', (event) => {
          console.log('상태 변경 드롭다운 변경됨:', event.target.value);
          this.updateBulkStatusSelect();
        });
      }

      handleSelectAll() {
        const isChecked = this.selectAllCheckbox.checked;
        console.log('전체 선택 처리:', isChecked);
        
        this.productCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        
        // 상태 변경 드롭다운 상태 업데이트
        this.updateSelectAllState();
        
        console.log('전체 선택 완료, 체크된 상품 개수:', 
          Array.from(this.productCheckboxes).filter(cb => cb.checked).length);
      }

      updateSelectAllState() {
        const checkedCount = Array.from(this.productCheckboxes).filter(cb => cb.checked).length;
        const totalCount = this.productCheckboxes.length;
        
        this.selectAllCheckbox.checked = checkedCount === totalCount;
        this.selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCount;
        
        this.updateBulkStatusSelectState();
      }

      updateBulkStatusSelectState() {
        const checkedCount = Array.from(this.productCheckboxes).filter(cb => cb.checked).length;
        console.log('체크된 상품 개수:', checkedCount);
        this.bulkStatusSelect.disabled = checkedCount === 0;
      }

      updateBulkStatusSelect() {
        const selectedValue = this.bulkStatusSelect.value;
        const checkedCount = Array.from(this.productCheckboxes).filter(cb => cb.checked).length;
        
        console.log('상태 변경 드롭다운 변경:', { selectedValue, checkedCount });
        
        if (selectedValue && checkedCount > 0) {
          console.log('일괄 상태 변경 시작:', selectedValue);
          this.handleBulkStatusChange(selectedValue);
        } else if (selectedValue && checkedCount === 0) {
          alert('선택된 상품이 없습니다. 상품을 선택한 후 다시 시도해주세요.');
        }
        
        // 드롭다운 초기화
        setTimeout(() => {
          this.bulkStatusSelect.value = '';
        }, 100);
      }

      async handleBulkStatusChange(newStatus) {
        const checkedCheckboxes = Array.from(this.productCheckboxes).filter(cb => cb.checked);
        const productIds = checkedCheckboxes.map(cb => Number(cb.value));
        
        console.log('일괄 상태 변경 처리:', { newStatus, productIds });
        
        if (productIds.length === 0) {
          alert('선택된 상품이 없습니다.');
          return;
        }

        const confirmMessage = `선택된 ${productIds.length}개의 상품을 '${newStatus}'로 변경하시겠습니까?`;
        if (!confirm(confirmMessage)) {
          return;
        }

        // 로딩 상태 표시
        this.bulkStatusSelect.disabled = true;
        this.bulkStatusSelect.classList.add('loading');

        try {
          const requestData = {
            productIds: productIds,
            status: newStatus
          };

          console.log('API 요청 데이터:', requestData);

          const response = await fetch('/seller/api/product/bulk-status', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
          });

          console.log('API 응답 상태:', response.status);

          const result = await response.json();
          console.log('API 응답 데이터:', result);

          if (result.header && result.header.rtcd === 'S00') {
            // 성공 시 테이블의 상태 드롭다운 업데이트
            checkedCheckboxes.forEach(checkbox => {
              const row = checkbox.closest('tr');
              const statusSelect = row.querySelector('.status-select');
              if (statusSelect) {
                statusSelect.value = newStatus;
                statusSelect.className = `status-select ${newStatus}`;
                statusSelect.setAttribute('data-original-status', newStatus);
              }
            });

            // 체크박스 선택 해제
            checkedCheckboxes.forEach(cb => cb.checked = false);
            this.updateSelectAllState();
            
            alert(`${productIds.length}개의 상품 상태가 성공적으로 변경되었습니다.`);
          } else {
            const errorMsg = result.header ? result.header.rtmsg : (result.message || '알 수 없는 오류');
            alert('상품 상태 변경에 실패했습니다: ' + errorMsg);
          }
        } catch (error) {
          console.error('일괄 상태 변경 중 오류:', error);
          alert('상품 상태 변경 중 오류가 발생했습니다.');
        } finally {
          // 로딩 상태 해제
          this.bulkStatusSelect.disabled = false;
          this.bulkStatusSelect.classList.remove('loading');
        }
      }
    }

    // ===== 상품 상태 업데이트 함수 =====
    async function updateProductStatus(selectElement) {
      const productId = selectElement.getAttribute('data-product-id');
      const newStatus = selectElement.value;
      const originalStatus = selectElement.getAttribute('data-original-status') || newStatus;
      
      // 로딩 상태 표시
      selectElement.disabled = true;
      selectElement.classList.add('loading');
      
      try {
        const requestData = {
          productId: productId,
          status: newStatus
        };
        
        const response = await fetch(API_ENDPOINTS.PRODUCT_STATUS, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        if (result.header && result.header.rtcd === 'S00') {
          // 성공 시 드롭다운 스타일 업데이트
          selectElement.className = `status-select ${newStatus}`;
          selectElement.setAttribute('data-original-status', newStatus);
          console.log('상품 상태가 성공적으로 업데이트되었습니다.');
        } else {
          // 실패 시 원래 값으로 되돌리기
          const errorMsg = result.header ? result.header.rtmsg : (result.message || '알 수 없는 오류');
          console.error('상품 상태 업데이트 실패:', errorMsg);
          alert('상품 상태 업데이트에 실패했습니다: ' + errorMsg);
          selectElement.value = originalStatus;
          selectElement.className = `status-select ${originalStatus}`;
        }
      } catch (error) {
        console.error('상품 상태 업데이트 중 오류:', error);
        alert('상품 상태 업데이트 중 오류가 발생했습니다.');
        selectElement.value = originalStatus;
        selectElement.className = `status-select ${originalStatus}`;
      } finally {
        // 로딩 상태 해제
        selectElement.disabled = false;
        selectElement.classList.remove('loading');
      }
    }

    // ===== 초기화 =====
    document.addEventListener('DOMContentLoaded', () => {
      new ProductListManager();
      
      // 초기 상태 설정
      const statusSelects = document.querySelectorAll('.status-select');
      statusSelects.forEach(select => {
        select.setAttribute('data-original-status', select.value);
      });
    });
  </script>
</body>
</html>